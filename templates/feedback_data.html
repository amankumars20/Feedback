<!DOCTYPE html>
<html>
<head>
    <title>Feedback Data Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>Feedback Summary Table</h1>

    <button onclick="fetchData()">Load JSON Data</button>
    <button onclick="downloadCSV()">Download as CSV</button>

    <pre id="jsonDisplay" style="background:#f5f5f5; padding:15px; margin-top:20px; border:1px solid #ccc;"></pre>

    <script>
    let rawData = [];

    function fetchData() {
        fetch("/admin/feedback-data")
            .then(response => response.json())
            .then(data => {
                rawData = data.data;
                document.getElementById("jsonDisplay").textContent = JSON.stringify(data, null, 4);
            })
            .catch(error => {
                document.getElementById("jsonDisplay").textContent = "Error fetching data: " + error;
            });
    }

    function downloadCSV() {
        if (rawData.length === 0) {
            alert("Please load the data first.");
            return;
        }

        const headers = [
            "file_name",
            "processed_at",
            "TotalComments",
            "sentiment",
            "FacultyMentions",
            "ThemeTags",
            "TopKeyPhrases"
        ];

        const csvRows = [headers.join(",")];

        rawData.forEach(item => {
            let sentiment = "UNKNOWN";
            const counts = item.SentimentCounts || {};
            const avg = item.AverageSentimentScores || {};

            if (Object.keys(counts).length > 0) {
                const maxCount = Object.entries(counts)
                    .map(([k, v]) => [k, parseInt(v)])
                    .reduce((a, b) => a[1] > b[1] ? a : b);
                sentiment = maxCount[0].toUpperCase();
            } else if (Object.keys(avg).length > 0) {
                const maxScore = Object.entries(avg)
                    .map(([k, v]) => [k, parseFloat(v)])
                    .reduce((a, b) => a[1] > b[1] ? a : b);
                sentiment = maxScore[0].toUpperCase();
            }

            const row = [
                `"${item.file_name || ''}"`,
                `"${item.processed_at || ''}"`,
                `"${item.TotalComments || ''}"`,
                `"${sentiment}"`,
                `"${flattenObject(item.FacultyMentions)}"`,
                `"${flattenObject(item.ThemeTags)}"`,
                `"${(item.TopKeyPhrases || []).join('; ')}"`
            ];

            csvRows.push(row.join(","));
        });

        const csvContent = csvRows.join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "feedback_summary_clean.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function flattenObject(obj) {
        if (!obj || typeof obj !== 'object') return '';
        return Object.entries(obj).map(([k, v]) => `${k}:${v}`).join('; ');
    }
    </script>
</body>
</html>
